<?php
/**
 * @var \DigitalOrigin\Pmt\Block\Product\Simulator $block
 */
if($block->isEnabled()==='1' && $block->getProductSimulator()==='1' && $block->getPublicKey()) {
    ?>
    <script>// <![CDATA[
        require([
            'jquery',
            'https://cdn.pagamastarde.com/js/pmt-v2/sdk.js',
            'https://cdn.pagantis.com/js/pg-v2/sdk.js'
        ], function ($, pmtSdk, pgSdk) {
            var moduleEnabled = '<? echo $block->isEnabled();?>';
            var simulatorEnabled = '<? echo $block->getProductSimulator();?>';
            var publicKey = '<? echo $block->getPublicKey();?>';
            var positionSelector = '<? echo $block->getPositionSelector();?>';
            var priceSelector = '<? echo $block->getPriceSelector();?>';
            var quantitySelector = '<? echo $block->getQuantitySelector();?>';
            var simulatorType = '<? echo $block->getSimulatorType();?>';
            var locale = '<? echo $block->getLocale();?>';

            if(moduleEnabled=='1' && simulatorEnabled=='1' && publicKey!='') {
                window.MGsimulatorId = null;

                if (locale == 'es' || locale=='')
                {
                    var pmt = pmtSdk;
                } else {
                    var pmt = pgSdk;
                }
                function loadSimulator() {
                    var pmtDiv = document.getElementsByClassName("installmentSimulator");
                    if(pmtDiv.length > 0) {
                        var pmtElement = pmtDiv[0];
                        if(pmtElement.innerHTML != '' )
                        {
                            clearInterval(window.WCSimulatorId);
                            return true;
                        }
                    }

                    var positionSelector = '<? echo $block->getPositionSelector();?>';
                    if (positionSelector === 'default' || positionSelector === '') {
                        positionSelector = '.installmentSimulator';
                    }

                    var priceSelector = '<? echo $block->getPriceSelector();?>';
                    if (priceSelector === 'default' || priceSelector === '') {
                        priceSelector = 'div.price-final_price span.price-wrapper span.price';
                    }
                    var quantitySelector = '<? echo $block->getQuantitySelector();?>';
                    if (quantitySelector === 'default' || quantitySelector === '') {
                        quantitySelector = 'div.fieldset div.qty div.control input.qty';
                    }
                    var simulatorType = '<? echo $block->getSimulatorType();?>';
                    if (simulatorType === 'default' || simulatorType === '') {
                        simulatorType = 'div.fieldset div.qty div.control input.qty';
                    }
                    if (typeof pmt != 'undefined') {
                        window.WCsimulatorId = pmt.simulator.init({
                            publicKey: publicKey,
                            type: simulatorType,
                            selector: positionSelector,
                            itemQuantitySelector: quantitySelector,
                            itemAmountSelector: priceSelector,
                            locale : locale
                        });
                    }

                    return false;
                }

                window.MGsimulatorId = setInterval(function () {
                    loadSimulator();
                }, 2000);
            }
        });
        // ]]>
    </script>
    <div class="installmentSimulator"></div>
    <?php
}
?>
