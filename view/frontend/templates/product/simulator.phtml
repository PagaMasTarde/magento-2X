<?php
/**
 * @var \Pagantis\Pagantis\Block\Product\Simulator $block
 */
if($block->isEnabled()==='1' && $block->getProductSimulator()==='1' && $block->getPublicKey()) {
    ?>
    <script>// <![CDATA[
        require([
            'jquery',
            'https://cdn.pagantis.com/js/pg-v2/sdk.js'
        ], function ($, pgSdk)
        {
            var moduleEnabled = '<?php echo $block->isEnabled();?>';
            var simulatorEnabled = '<?php echo $block->getProductSimulator();?>';
            var publicKey = '<?php echo $block->getPublicKey();?>';
            var locale = '<?php echo $block->getLocale();?>';
            var country = '<?php echo $block->getCountry();?>';
            var allowedCountry = '<?php echo $block->getAllowedCountry($block->getLocale());?>';
            var promotedProduct = '<?php echo $block->getPromoted();?>';
            var simulatorType = '<?php echo $block->getSimulatorType();?>';
            var thousandSeparator = '<?php echo $block->getThousandSeparator();?>';
            var decimalSeparator = '<?php echo $block->getDecimalSeparator();?>';
            var numInstallments = '<?php echo $block->getMinInstallments();?>';
            var validAmount = '<?php echo $block->checkValidAmount();?>';
            var minAmount = '<?php echo $block->getMinAmount();?>';
            var maxAmount = '<?php echo $block->getMaxAmount();?>';

            if(moduleEnabled=='1' && simulatorEnabled=='1' && publicKey!='' && allowedCountry=='1' && validAmount=='1'){

                window.sdk = pgSdk;

                function checkSimulatorContent() {
                    var simulatorLoaded = false;
                    var positionSelector = findPositionSelector();
                    var pmtDiv = document.querySelectorAll(positionSelector);
                    if (pmtDiv.length>0 && typeof window.MGSimulatorId!='undefined') {
                        var pmtElement = pmtDiv[0];
                        if (pmtElement.innerHTML != '') {
                            simulatorLoaded = true;
                        }
                    }
                    return simulatorLoaded;
                }

                function moveToPrice()
                {
                    if (simulatorType === 'sdk.simulator.types.SELECTABLE_TEXT_CUSTOM' ||
                        simulatorType === 'sdk.simulator.types.PRODUCT_PAGE') {
                        var simnode = document.querySelector(findPositionSelector());

                        var detailnode = document.getElementsByClassName('product-add-form');
                        detailnode = detailnode['0'];

                        detailnode.parentNode.insertBefore(simnode, detailnode)
                    }
                }

                function checkAttempts() {
                    window.attempts = window.attempts + 1;
                    return (window.attempts > 4)
                }

                function finishInterval() {
                    return clearInterval(window.loadingSimulator);
                }

                function findPriceSelector()
                {
                    var priceSelector = '<?php echo $block->getPriceSelector();?>';
                    if (priceSelector === 'default' || priceSelector === '') {
                        priceSelector = 'div.price-final_price span.price-wrapper span.price';
                    }

                    return priceSelector;
                }

                function findQuantitySelector()
                {
                    var quantitySelector = '<?php echo $block->getQuantitySelector();?>';
                    if (quantitySelector === 'default' || quantitySelector === '') {
                        quantitySelector = 'div.fieldset div.qty div.control input.qty';
                    }

                    return quantitySelector;
                }

                function findPositionSelector() {
                    var positionSelector = '<?php echo $block->getPositionSelector();?>';
                    if (positionSelector === 'default' || positionSelector === '') {
                        positionSelector = '.pagantisSimulator';
                    }

                    return positionSelector;
                }

                function loadSimulator() {
                    if (typeof window.sdk == 'undefined')
                    {
                        return false;
                    }

                    if (checkAttempts() || checkSimulatorContent())
                    {
                        return finishInterval();
                    }
                    else
                    {
                        var priceSelector = findPriceSelector();
                        var quantitySelector = findQuantitySelector();
                        var positionSelector = findPositionSelector();
                        simulator_options = {
                            numInstalments: numInstallments,
                            publicKey: publicKey,
                            type: eval(simulatorType),
                            selector: positionSelector,
                            itemAmountSelector: priceSelector,
                            locale: locale,
                            country: country,
                            amountParserConfig: {
                                thousandSeparator: thousandSeparator,
                                decimalSeparator: decimalSeparator
                            }
                        }
                        
                        var qtyDiv = document.querySelectorAll(quantitySelector);
                        if(qtyDiv.length > 0)
                        { simulator_options.itemQuantitySelector = quantitySelector; }
                        else
                        { simulator_options.itemQuantity = 1; }
                    };

                    if (promotedProduct == 'true') {
                        simulator_options.itemPromotedAmountSelector = priceSelector;
                    }

                    if (typeof window.sdk != 'undefined') {
                        window.MGSimulatorId = window.sdk.simulator.init(simulator_options);
                        if(window.MGSimulatorId != '') {
                            moveToPrice();
                        }
                        return false;
                    }

                    return false;
                }

                window.attempts = 0;
                window.loadingSimulator = setInterval(function () {
                    loadSimulator();
                }, 2000);
            }
        });
        // ]]>
    </script>
    <style>
        .pg-no-interest{
            color: #00c1d5
        }
        .promoted{
            width: 75%;
            margin: auto;
        }
    </style>
    <?php
        if ($block->getPromoted() == 'true') {
            echo $block->getPromotedMessage();
        }
    ?>
    <style>
        select.pg-sim-custom-selector-control {
            width: 55px;
        }
    </style>
    <div class="pagantisSimulator" style="display: flex"></div>
    <p></p>
    <?php
}
?>
